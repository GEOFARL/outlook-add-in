<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<script type="module">
    import { msalInstance, msalReady, API_SCOPE } from "/_assets/msal.js";
    import { DBG } from "/_assets/debug.js";

    const inDialog = () =>
    window.location.search.includes("dialog=1") &&
    !!(window.Office && Office.context?.ui?.messageParent);

  let ackedByParent = false;

  function installAckHandler() {
    if (!inDialog()) return;
    try {
      Office.context.ui.addHandlerAsync(Office.EventType.DialogParentMessageReceived, (evt) => {
        try {
          const msg = JSON.parse(evt?.message || "{}");
          if (msg?.type === "ack-close") {
            ackedByParent = true;
            if (Office.context.ui.closeContainer) {
              Office.context.ui.closeContainer();
            } else {
              window.close();
            }
          }
        } catch {}
      });
    } catch {}
  }

  function sendOnAllChannels(token: string) {
    try {
      Office.context.ui.messageParent(JSON.stringify({ type: "aad-token", token }));
    } catch {}

    try {
      const bc = new BroadcastChannel("aad-auth");
      bc.postMessage({ type: "aad-token", token });
      setTimeout(() => bc.close(), 200);
    } catch {}

    try {
      localStorage.setItem("aad_token_drop", JSON.stringify({ token, ts: Date.now() }));
    } catch {}
  }

  async function sendTokenAndExit(token: string) {
    if (inDialog()) {
      sendOnAllChannels(token);

      setTimeout(() => {
        if (!ackedByParent) {
          try {
            if (Office.context.ui.closeContainer) Office.context.ui.closeContainer();
            else window.close();
          } catch {}
        }
      }, 1500);
      return;
    }
    window.location.replace("/taskpane.html");
  }

  async function run() {
    await msalReady;

    try {
      const res = await msalInstance.handleRedirectPromise();
      if (res?.account) msalInstance.setActiveAccount(res.account);
    } catch {}

    let account = msalInstance.getActiveAccount() || msalInstance.getAllAccounts()[0];

    if (!account) {
      await msalInstance.loginRedirect({ scopes: [API_SCOPE], prompt: "select_account" });
      return;
    }

    installAckHandler();

    try {
      const tokenRes = await msalInstance.acquireTokenSilent({ scopes: [API_SCOPE], account });
      await sendTokenAndExit(tokenRes.accessToken);
    } catch (e) {
      if (e instanceof InteractionRequiredAuthError) {
        await msalInstance.loginRedirect({ scopes: [API_SCOPE], prompt: "select_account" });
        return;
      }
      try {
        if (inDialog()) {
          Office.context.ui.messageParent(
            JSON.stringify({ type: "aad-error", error: String(e?.message || e) })
          );
        }
      } catch {
      }
      setTimeout(() => {
        try {
          if (Office.context.ui.closeContainer) Office.context.ui.closeContainer();
          else window.close();
        } catch {
        }
      }, 1500);
    }
  }

  if (window.Office && Office.onReady) {
    Office.onReady().then(run);
  } else {
    run();
  }
</script>
